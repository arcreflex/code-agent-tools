# Agent Sandbox Specification

## Overview

Agent-sandbox provides Docker-based containerized environments with guardrails that prevent AI agents from bypassing development quality controls.

## Image Model

Agent-sandbox uses a two-layer image model:

- **Base image**: `agent-sandbox-base:<tag>` built from `packages/agent-sandbox/base-image/Dockerfile`.
- **Per-repo image**: a minimal Dockerfile generated by `agent-sandbox init` that derives from the base image and adds only repo-specific requirements.

### Base image contents

Preinstalled shared tooling:

- Core utilities: `less`, `fzf`, `man-db`, `unzip`, `jq`, `aggregate`, `procps`
- VCS/diff: `git`, `gh`, `git-delta`
- Editors: `nano`, `vim`
- Network/security: `sudo`, `gnupg2`, `iptables`, `ipset`, `iproute2`, `dnsutils`
- AI CLIs (global): `@anthropic-ai/claude-code`, `@openai/codex`, `opencode-ai`
- Code search: `@ast-grep/cli` (ast-grep)

Environment and guardrails:

- Non-root user `node`, persistent history at `/commandhistory`, config at `/home/node/.claude` and `/home/node/.codex`
- `ENTRYPOINT` runs `entrypoint.sh` which initializes the firewall and then starts a shell (interactive) or `tail -f /dev/null` (detached)
- Security scripts:
  - `init-firewall.sh` (iptables/ipset allowlist)
  - `git-wrapper.sh` (blocks `--no-verify`, force pushes)
  - `entrypoint.sh` (invokes firewall init)

Dockerfile practices:

- Uses `--no-install-recommends` and cleans apt lists
- Pins versions via build args where practical
- Runs as non-root for normal operation; uses scoped sudo for firewall init
- Sets standardized `WORKDIR=/workspace`

### Per-repo Dockerfile (template)

Per-repo Dockerfiles are minimal and derive from the base image:

````

ARG BASE_IMAGE_TAG=latest
FROM agent-sandbox-base:${BASE_IMAGE_TAG}

# Optional repo-specific additions; do not change ENTRYPOINT/USER.

```

Guidelines:

- Add only repo-specific OS packages or global tools unique to the repo
- Do not reinstall shared AI CLIs or copy the security scripts
- Do not change `ENTRYPOINT` or `USER` unless strictly required
- Do not copy application code; the workspace is bind-mounted at runtime

## Building Images

CLI:

- `agent-sandbox build-base [--tag <tag>] [--claude-code-version <v>] [--codex-version <v>] [--git-delta-version <v>] [--ast-grep-version <v>]`
  - Builds `agent-sandbox-base:<tag>` from `packages/agent-sandbox/base-image/Dockerfile`
  - Floating `latest` versions are resolved to concrete npm versions to improve Docker cache reuse
- `agent-sandbox build [path] [--base-tag <tag>]`
  - Builds the per-repo image in `.agent-sandbox/` with `--build-arg BASE_IMAGE_TAG=<tag>` (default `latest`)

## Container Management

### Lifecycle

- `init [path]` — initializes `.agent-sandbox` and builds the image; creates persistent volumes for configs and history
- `build [path]` — builds the per-repo image
- `start [path] [--branch <name>] [--base-tag <tag>] [--build]` — starts the container (auto-started by `shell` if needed)
- `stop [path]` — stops and removes the running container (`--rm` is used at start)
- `shell [path] [--branch <name>] [--build]` — opens an interactive shell; ensures provisioning for the requested branch
- `show-run [path] [--base-tag <tag>]` — prints the `docker run` command
- `list` — lists running agent-sandbox containers
- `admin [path] [--root] [--build]` — opens an admin shell (see **Admin Mode**)

### Container, Volume, and Identity

- Container name: `agent-sandbox-<repoName>-<hash>`
- Repo-shelf volume name: `agent-sbx-repo-<md5(abs path)>`
- History volume: `agent-sandbox-history-<repoName>-<hash>`
- Labels expose `workspace` (host path), `mode` (`multi-branch` or `admin`), and `repoShelfVolume`

## Repo-Shelf Worktrees

### Layout and behavior

Every sandbox container mounts:

1. a shared **repo-shelf** Docker volume at `/repo-shelf`
2. the host repository bind at `/workspace/<repoName>`

Branch selection is handled at exec time:

- `agent-sandbox shell --branch <name>` ensures the worktree exists under `/repo-shelf/worktrees/<branchSan>` and `docker exec -w` enters that path.
- The primary repo lives at `/repo-shelf/repo` with a persistent `host` remote pointing to `file:///workspace/<repoName>`.
- Each worktree configures `branch.<name>.remote=host` and `branch.<name>.merge=refs/heads/<name>`, so a plain `git push` targets `host/<branch>`.

Provisioning is idempotent:

- Creates the repo-shelf volume if needed
- Clones from the host bind if `/repo-shelf/repo` does not exist
- Ensures/fetches the `host` remote
- Creates or updates the requested worktree
- Tracks the host branch by default; if the branch is missing, a reasonable default branch is used

### Example paths

```

/repo-shelf
/repo                 # non-bare repo sharing the object store
/worktrees
/<branch-sanitized> # one worktree per branch

````

## Network Security

### Firewall

`init-firewall.sh` applies a default-deny egress policy:

- Allows outbound DNS and SSH
- Maintains an ipset of allowed destinations
- Restores internal Docker DNS NAT rules as needed
- Verifies policy by blocking generic external destinations and allowing GitHub API

### Allowlist

- **Package registries**: npm
- **AI services**: OpenRouter, OpenAI, Anthropic
- **Developer services**: GitHub (IP ranges fetched via GitHub meta API)
- **Monitoring**: Sentry, Statsig

Extra egress destinations can be added via `/.agent-sandbox/config.json`:

```json
{ "egress_allow_domains": ["example.com", "api.example.dev"] }
```

## Protected Directories

Readonly overlays prevent modification of sensitive paths:

- `.git/hooks`
- `.husky`
- `.agent-sandbox`
- `.ai-review/user-context.json`

Additional paths can be configured in `.agent-sandbox/config.json`.

## Git Integration

`git-wrapper.sh` intercepts Git commands and blocks:

- `git commit --no-verify`
- `git commit -n`
- `git push --force`
- `git push --force-with-lease`

## Admin Mode

`agent-sandbox admin [--root]` opens a shell with relaxed guardrails for repair and maintenance:

- Mounts the same volumes as normal mode
- Starts in `/workspace/<repoName>`
- Omits the sandbox marker mount and readonly overlays
- Optional `--root` runs as UID/GID `0:0`

Use normal mode for daily work; admin mode is intended for exceptional tasks. Network firewall behavior remains the same.
