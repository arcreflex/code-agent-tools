# Agent Sandbox Specification

## Overview

Agent-sandbox provides Docker-based containerized environments with development guardrails to prevent AI agents from bypassing quality controls.

## Image Model

Agent-sandbox uses a two-layer image model:

- Base image: `agent-sandbox-base:<tag>` built from `packages/agent-sandbox/base-image/Dockerfile`.
- Per-repo image: A minimal Dockerfile generated by `agent-sandbox init` that derives from the base image and only adds repo-specific requirements.

### Base image contents

- Preinstalled CLI tools and system packages that are shared across repos:
  - Core utilities (`less`, `fzf`, `man-db`, `unzip`, `jq`, `aggregate`, `procps`)
  - VCS and diff tooling (`git`, `gh`, `git-delta`)
  - Editors (`nano`, `vim`)
  - Network/security (`sudo`, `gnupg2`, `iptables`, `ipset`, `iproute2`, `dnsutils`)
  - AI CLIs (global): `@anthropic-ai/claude-code`, `@openai/codex`
  - Code search/lint: `@ast-grep/cli` (ast-grep)
- Non-root user (`node`) and shell environment setup (history, aliases, prompt, `ENTRYPOINT`).
- Security scripts and wrappers copied into the image:
  - `init-firewall.sh` (iptables/ipset allowlist)
  - `git-wrapper.sh` (blocks `--no-verify`, force pushes)
  - `entrypoint.sh` (invokes firewall init and interactive shell)
- Standardized workdir (`/workspace`) and persistent config/home paths
  (`/home/node/.claude`, `/home/node/.codex`, `/commandhistory`).

The base Dockerfile adheres to Docker best practices:

- Uses `--no-install-recommends` and cleans apt lists to keep layers small.
- Pins versions via build args where practical; base tags are not floating.
- Runs as non-root (`USER node`) for normal operation, with scoped sudo for firewall init.
- Keeps `ENTRYPOINT` in the base to standardize startup behavior across repos.

### Per-repo Dockerfile (template used by `agent-sandbox init`)

Per-repo Dockerfiles are minimal and derive from the base image. Include:

- `FROM agent-sandbox-base:<tag>` (required).
- Optional repo-specific OS packages strictly required by that repo.
- Optional additional global tools that are unique to the repo (avoid duplicating base tools).
- Optional labels or metadata.

Per-repo Dockerfiles MUST NOT:

- Reinstall shared AI CLIs, core packages, or copy the security scripts.
- Add an `ENTRYPOINT` or change the `USER` unless the repo has a special need.
- Copy application code into the image; the workspace is bind-mounted at runtime.

Per-repo Dockerfile template:

```
ARG BASE_IMAGE_TAG=latest
FROM agent-sandbox-base:${BASE_IMAGE_TAG}

# Optional: repo-specific packages (keep minimal and clean caches)
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     <repo-specific-packages> \
#   && rm -rf /var/lib/apt/lists/*

# Optional: extra global tools unique to this repo
# RUN npm install -g <tool>@<version>

# Inherit ENTRYPOINT/USER/WORKDIR from base
```

The `BASE_IMAGE_TAG` build arg selects the base tag; the CLI passes this during `build`.

### Building and updating images

CLI support:

- `build-base [--tag <tag>] [--claude-code-version <v>] [--codex-version <v>] [--git-delta-version <v>] [--ast-grep-version <v>]`
  - Builds or rebuilds `agent-sandbox-base:<tag>` locally from `packages/agent-sandbox/base-image/Dockerfile`.
  - Defaults: `--tag latest` and tool versions defined by the base Dockerfile defaults.
  - When a tool version is `latest`, the CLI resolves it to a concrete npm version before building to maximize Docker layer caching (no `--no-cache` used).

- `build [path] [--base-tag <tag>]`
  - Builds the per-repo image in `.agent-sandbox/` and passes `--build-arg BASE_IMAGE_TAG=<tag>` to the Docker build.
  - If `--base-tag` is omitted, uses `latest`.

Update flow for bumping AI CLIs or shared tools:

1. Build a new base: `agent-sandbox build-base --tag 2024-08-12 --claude-code-version 1.2.3 --codex-version 4.5.6`.
2. Rebuild the per-repo image with the new base tag: `agent-sandbox build --base-tag 2024-08-12`.
3. Or use `latest` tag and rebuild: `agent-sandbox build-base` then `agent-sandbox build`.

This keeps repo images thin, leverages Docker layer caching, and makes upgrades predictable.

## Container Management

### Lifecycle Commands

- `init [path]` - Initialize sandbox for a workspace directory
  - Initializes .agent-sandbox and builds image
  - Sets up persistent volumes for configs and history
  - Options: `--force` to remove existing containers/directories
- `build [path]` - Build the Docker image for the sandbox
- `build-base [--tag <tag>]` - Build or rebuild the shared base image locally
- `start [path]` - Start the sandbox container
  - Auto-started when running `shell` if not running
- `stop [path]` - Stop the running container

- `shell [path]` - Open interactive shell in container
  - Automatically starts container if not running
  - Default command when no subcommand is provided

- `show-run [path]` - Display docker run command without executing

- `volume` - Get config volume name

### Container Naming

- Uses MD5 hash of workspace path for unique container/volume names
- Enables multiple workspace isolation on same machine

### Persistent Storage

Named volumes that persist across container recreations:

- Claude Code config: `agent-sandbox-claude-code-config`
- Codex config: `agent-sandbox-codex-config`
- Bash history: `agent-sandbox-<hash>-history`

## Network Security

### Firewall System

Comprehensive iptables-based firewall (`init-firewall.sh`):

- Blocks all outbound traffic by default
- Only allows explicitly permitted domains/IPs
- Uses `ipset` for efficient domain management
- Validates firewall effectiveness at setup time

### Allowed Services

Pre-configured access to:

- **Package Registries**: npm registry
- **AI Services**: OpenRouter, OpenAI, Anthropic
- **Development Tools**: GitHub (dynamically fetched IP ranges)
- **Monitoring**: Sentry, Statsig

### Dynamic IP Management

- GitHub IP ranges fetched via API at container startup
- Domain names resolved and added to ipset
- Automatic DNS resolution for allowed domains

## Protected Directories

### Default Protected Paths

Readonly overlay prevents modification of:

- `.git/hooks` - Git hooks configuration
- `.husky` - Husky pre-commit hooks
- `.agent-sandbox` - Sandbox configuration
- `.agent-precommit/user-context.json` - Precommit context

### Configurable Protection

Additional directories can be protected via configuration file.

## Git Integration

### Git Wrapper

Custom git wrapper script (`git-wrapper.sh`) that:

- Intercepts git commands
- Blocks bypass attempts like `git commit --no-verify`, `git push --force`

### Blocked Operations

- `git commit --no-verify`
- `git commit -n`
- `git push --force`
- `git push --force-with-lease`
- Modifications to `.git/hooks/*`
- Modifications to protected directories

## Development Environment

The base image provides a standardized development environment with common CLI tools, editors, and network/security utilities (see Image Model for the complete list). Repo images inherit this environment.

### AI Development CLIs

Pre-installed globally in the base image:

- **Claude Code**: Config at `/home/node/.claude`
- **OpenAI Codex**: Config at `/home/node/.codex`
- **ast-grep**: Installed as `ast-grep`/`sg` on PATH for structural search and rewrite

## Codex configuration and auth

Codex uses a local OAuth callback on `http://localhost:1455/auth/callback` and stores credentials in `~/.codex/auth.json`. The sandbox persists these credentials and related configuration in a shared Codex config volume so all sandboxes can reuse them.

### Initialize Codex config

```
# Initialize shared Codex config in the sandbox volume
agent-sandbox codex-init-config [--auth]
```

Behavior:

- Initializes the shared Codex config volume (mounted at `/home/node/.codex`).
- Ensures a `config.toml` exists with a "high" profile for GPT‑5 configured for high reasoning effort.
- Creates or updates an `AGENTS.md` note inside the Codex config volume describing the containerized sandbox environment and installed tools.
- With `--auth`, imports host Codex credentials into the shared volume.
- Idempotent by default: if `config.toml`, `AGENTS.md`, or `profile.json` already exist in the volume, they are left as‑is and a message is printed. Use `--force` to overwrite these files. (Exception: `auth.json` is always overwritten if `--auth` is set.)

Example `config.toml` profile created/ensured by this command:

```
[profiles.high]
model = "gpt-5"
# Constrains reasoning effort for reasoning-capable models
reasoning_effort = "high"
```

AGENTS.md content (created/updated in the Codex config volume):

- Purpose: You are running inside a containerized sandbox (agent-sandbox) designed to provide a safe, auditable coding environment with network/filesystem guardrails.
- Persistence: Tool/config directories (e.g., `~/.codex`) are backed by a named Docker volume shared across repo sandboxes.
- Installed tools: ast-grep (`ast-grep` / `sg`) for structural search and rewrites. Additional tools may be added over time.

### Login on host and import auth

```
codex login              # on host once
agent-sandbox codex-init-config --auth
```

Copies `~/.codex/auth.json` (and `profile.json` if present) from the host into the shared Codex volume in addition to initializing `config.toml` and `AGENTS.md`. Use `--force` to overwrite existing files in the volume.

### Removing local credentials

```
agent-sandbox codex-logout
```

Deletes `auth.json` and `profile.json` from the shared Codex volume (does not revoke server-side tokens).

### Firewall allowlist

The base image firewall allows the required domains for Codex, including `api.openai.com`, `auth.openai.com`, and `chatgpt.com`.

### Custom Aliases

- `freeclaude` - Run Claude Code without permission checks

### Shell Configuration

- Optimized bash settings
- Persistent command history
- Enhanced prompt and colors

## Configuration

### Workspace Configuration

Configuration stored in `.agent-sandbox/` directory:

- Container settings
- Protected directory list
- Custom environment variables

### Environment Detection

- Marker file `/.agent-sandbox` indicates sandbox environment
- Used by other tools (like agent-precommit) for conditional behavior

## Security Features

### Process Isolation

- Runs as non-root user (`node`)
- Limited container capabilities
- No privileged operations

### Filesystem Protection

- Readonly bind mounts for sensitive directories
- Workspace mounted with write access (except protected paths)

### Network Isolation

- Default-deny outbound policy
- Explicit allowlist for required services
- No inbound by default (unless ports are published)

## Testing

### Test Scripts

- `test-git-wrapper.sh` - Validates git wrapper functionality
  - Tests blocked commands
  - Verifies allowed operations
  - Checks bypass prevention

### Integration Testing

- Manual testing in sandbox environment
- Verification of firewall rules
- CLI functionality validation

## Dual-Mount, Branch-Aware Mode

### Goal
Enable multiple concurrent sandboxes per repo without proliferating volumes, while keeping strong isolation between host and sandbox. We always mount:
1) a single shared **repo-shelf** Docker volume (per upstream repo) at `/repo-shelf`
2) the **host bind** of the current working repo at `/workspace/<repoName>`

The only difference between modes is the container **working directory**:
- **Bind mode** (default): `WORKDIR=/workspace/<repoName>`
- **Branch mode** (`--branch <name>`): `WORKDIR=/repo-shelf/worktrees/<branch-sanitized>`

### Layout inside the shared volume
```

/repo-shelf
/repo                    # primary non-bare repo (shares object store)
/worktrees
/<branch-sanitized>    # one worktree per branch

```

### Host remote
The primary repo at `/repo-shelf/repo` has a persistent remote:
```

host → file:///workspace/<repoName>

```
This lets a sandbox push directly back to the host checkout with:
```

git push host <branch>

```
Git’s default safety (deny push to checked-out branch) stays in place; typically the host has `main` checked out, so pushing feature branches is allowed.

### Provisioning (idempotent)
When `--branch <name>` is requested (or the provisioning helper is invoked), run a short-lived container from the base image, mounting **both** the repo-shelf volume and the host bind:

1. **Ensure the repo-shelf volume exists** (named from upstream repo identity; see “Volume naming”).
2. **Prime the primary repo**:
   - If `/repo-shelf/repo/.git` is missing: `git clone --no-checkout "<ORIGIN_URL>" /repo-shelf/repo`
   - `git -C /repo-shelf/repo remote set-url origin "<ORIGIN_URL>" || true`
   - `git -C /repo-shelf/repo fetch --prune origin`
3. **Wire the host remote**:
   - `git -C /repo-shelf/repo remote add host "file:///workspace/<repoName>" || git -C ... remote set-url host "file:///workspace/<repoName>"`
4. **Ensure the branch worktree**:
   - `BR_DIR=/repo-shelf/worktrees/<branch-sanitized>`
   - If `origin/<branch>` exists: `git -C /repo-shelf/repo worktree add -B "<branch>" "$BR_DIR" "origin/<branch>"`
   - Else: `git -C /repo-shelf/repo worktree add -b "<branch>" "$BR_DIR" origin/main`

> **Sanitization**: replace `/` and whitespace with `__` for worktree directory names.

### CLI changes

#### New/updated flags
- `--branch <name>`: switch to branch mode (provision if needed, set workdir to worktree)

#### New/updated commands
- `start [path] [--branch <name>] [--base-tag <tag>] [--build]`
  - Always mounts both repo-shelf and host bind.
  - Sets workdir based on branch flag.
  - If `--branch` is present: runs provisioning (idempotent) before start.
- `shell [path] [--branch <name>] [--build]`
  - Same as `start` but then opens shell (existing behavior), using branch workdir if provided.
- `checkout <branch> [--base-tag <tag>]`
  - Provision repo-shelf + worktree only (no container start).
- `list`
  - Show running containers with: repo, mode, workdir, and mapped volumes.
- `show-run [path] [--branch <name>]`
  - Print the full `docker run` command with both mounts and computed workdir.

#### Backward compatibility
- If no `--branch` is provided, behavior remains “bind mode”, but repo-shelf is still mounted for parity and easy `cd` into worktrees later.
- No changes to firewall or git-wrapper semantics.

### Volume naming
- **Repo-shelf**: one volume per host repo path (not per sandbox).
  - Name: `agent-sbx-repo-<pathHash>`
  - `pathHash` = MD5 of the absolute host workspace path (stable per clone path on a given machine).
- **History/config volumes**: unchanged (per current design).

### Container naming (branch mode)
Append the sanitized branch name to the existing scheme:
```

agent-sandbox-<repoName>-<branchSan>-<hash>

```

### Concurrency & safety
- Multiple containers can operate on different worktrees safely.
- Provisioning should be idempotent. If two branch sandboxes race on first creation, allow one to fail and retry, or serialize with a simple file lock (future improvement).
- `git push host <branch>`:
  - Will be rejected if the host has that branch checked out (desired).
  - Otherwise accepted; host hooks (if any) will run.

### Testing checklist
- Start two sandboxes for different branches → both mount the same repo-shelf; independent workdirs.
- From a branch sandbox: commit + `git push host <branch>` succeeds when host has `main` checked out.
- From bind-mode container: `cd /repo-shelf/worktrees/<branchSan>` and operate normally.
- `list` shows containers with correct mode and workdir.
