# Agent Sandbox Specification

## Overview

Agent-sandbox provides Docker-based containerized environments with development guardrails to prevent AI agents from bypassing quality controls.

## Image Model

Agent-sandbox uses a two-layer image model:

- Base image: `agent-sandbox-base:<tag>` built from `packages/agent-sandbox/base.Dockerfile`.
- Per-repo image: A minimal Dockerfile generated by `agent-sandbox init` that derives from the base image and only adds repo-specific requirements.

### Base image contents

- Preinstalled CLI tools and system packages that are shared across repos:
  - Core utilities (`less`, `fzf`, `man-db`, `unzip`, `jq`, `aggregate`, `procps`)
  - VCS and diff tooling (`git`, `gh`, `git-delta`)
  - Editors (`nano`, `vim`)
  - Network/security (`sudo`, `gnupg2`, `iptables`, `ipset`, `iproute2`, `dnsutils`)
  - AI CLIs (global): `@anthropic-ai/claude-code`, `@openai/codex`
- Non-root user (`node`) and shell environment setup (history, aliases, prompt, `ENTRYPOINT`).
- Security scripts and wrappers copied into the image:
  - `init-firewall.sh` (iptables/ipset allowlist)
  - `git-wrapper.sh` (blocks `--no-verify`, force pushes)
  - `entrypoint.sh` (invokes firewall init and interactive shell)
- Standardized workdir (`/workspace`) and persistent config/home paths
  (`/home/node/.claude`, `/home/node/.codex`, `/commandhistory`).

The base Dockerfile adheres to Docker best practices:

- Uses `--no-install-recommends` and cleans apt lists to keep layers small.
- Pins versions via build args where practical; base tags are not floating.
- Runs as non-root (`USER node`) for normal operation, with scoped sudo for firewall init.
- Keeps `ENTRYPOINT` in the base to standardize startup behavior across repos.

### Per-repo Dockerfile (template used by `agent-sandbox init`)

Per-repo Dockerfiles are minimal and derive from the base image. Include:

- `FROM agent-sandbox-base:<tag>` (required).
- Optional repo-specific OS packages strictly required by that repo.
- Optional additional global tools that are unique to the repo (avoid duplicating base tools).
- Optional labels or metadata.

Per-repo Dockerfiles MUST NOT:

- Reinstall shared AI CLIs, core packages, or copy the security scripts.
- Add an `ENTRYPOINT` or change the `USER` unless the repo has a special need.
- Copy application code into the image; the workspace is bind-mounted at runtime.

Per-repo Dockerfile template:

```
ARG BASE_IMAGE_TAG=latest
FROM agent-sandbox-base:${BASE_IMAGE_TAG}

# Optional: repo-specific packages (keep minimal and clean caches)
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     <repo-specific-packages> \
#   && rm -rf /var/lib/apt/lists/*

# Optional: extra global tools unique to this repo
# RUN npm install -g <tool>@<version>

# Inherit ENTRYPOINT/USER/WORKDIR from base
```

The `BASE_IMAGE_TAG` build arg selects the base tag; the CLI passes this during `build`.

### Building and updating images

CLI support:

- `build-base [--tag <tag>] [--claude-code-version <v>] [--codex-version <v>] [--git-delta-version <v>]`
  - Builds or rebuilds `agent-sandbox-base:<tag>` locally from `packages/agent-sandbox/template/Dockerfile`.
  - Defaults: `--tag latest` and tool versions defined by the base Dockerfile defaults.

- `build [path] [--base-tag <tag>]`
  - Builds the per-repo image in `.agent-sandbox/` and passes `--build-arg BASE_IMAGE_TAG=<tag>` to the Docker build.
  - If `--base-tag` is omitted, uses `latest` or the value in `.agent-sandbox/config.json` (see below).

Optional config for deterministic repo builds:

```jsonc
// .agent-sandbox/config.json
{
  // ...existing fields
  "baseImage": "agent-sandbox-base",
  "baseTag": "2024-08-12",
}
```

Update flow for bumping AI CLIs or shared tools:

1. Build a new base: `agent-sandbox build-base --tag 2024-08-12 --claude-code-version 1.2.3 --codex-version 4.5.6`.
2. Update `baseTag` in each repoâ€™s `.agent-sandbox/config.json` (or pass `--base-tag`).
3. Rebuild the per-repo image: `agent-sandbox build`.

This keeps repo images thin, leverages Docker layer caching, and makes upgrades predictable.

## Container Management

### Lifecycle Commands

- `init [path]` - Initialize sandbox for a workspace directory
  - Initializes .agent-sandbox and builds image
  - Sets up persistent volumes for configs and history
  - Options: `--force` to remove existing containers/directories
- `build [path]` - Build the Docker image for the sandbox
- `build-base [--tag <tag>]` - Build or rebuild the shared base image locally
- `start [path]` - Start the sandbox container
  - Auto-started when running `shell` if not running
- `stop [path]` - Stop the running container

- `shell [path]` - Open interactive shell in container
  - Automatically starts container if not running
  - Default command when no subcommand is provided

- `show-run [path]` - Display docker run command without executing

- `volume` - Get config volume name

### Container Naming

- Uses MD5 hash of workspace path for unique container/volume names
- Enables multiple workspace isolation on same machine

### Persistent Storage

Named volumes that persist across container recreations:

- Claude Code config: `agent-sandbox-claude-code-config`
- Codex config: `agent-sandbox-codex-config`
- Bash history: `agent-sandbox-<hash>-history`

## Network Security

### Firewall System

Comprehensive iptables-based firewall (`init-firewall.sh`):

- Blocks all outbound traffic by default
- Only allows explicitly permitted domains/IPs
- Uses `ipset` for efficient domain management
- Validates firewall effectiveness at setup time

### Allowed Services

Pre-configured access to:

- **Package Registries**: npm registry
- **AI Services**: OpenRouter, OpenAI, Anthropic
- **Development Tools**: GitHub (dynamically fetched IP ranges)
- **Monitoring**: Sentry, Statsig

### Dynamic IP Management

- GitHub IP ranges fetched via API at container startup
- Domain names resolved and added to ipset
- Automatic DNS resolution for allowed domains

## Protected Directories

### Default Protected Paths

Readonly overlay prevents modification of:

- `.git/hooks` - Git hooks configuration
- `.husky` - Husky pre-commit hooks
- `.agent-sandbox` - Sandbox configuration
- `.agent-precommit/user-context.json` - Precommit context

### Configurable Protection

Additional directories can be protected via configuration file.

## Git Integration

### Git Wrapper

Custom git wrapper script (`git-wrapper.sh`) that:

- Intercepts git commands
- Blocks bypass attempts like `git commit --no-verify`, `git push --force`

### Blocked Operations

- `git commit --no-verify`
- `git commit -n`
- `git push --force`
- `git push --force-with-lease`
- Modifications to `.git/hooks/*`
- Modifications to protected directories

## Development Environment

The base image provides a standardized development environment with common CLI tools, editors, and network/security utilities (see Image Model for the complete list). Repo images inherit this environment.

### AI Development CLIs

Pre-installed globally in the base image:

- **Claude Code**: Config at `/home/node/.claude`
- **OpenAI Codex**: Config at `/home/node/.codex`

### Custom Aliases

- `freeclaude` - Run Claude Code without permission checks

### Shell Configuration

- Optimized bash settings
- Persistent command history
- Enhanced prompt and colors

## Configuration

### Workspace Configuration

Configuration stored in `.agent-sandbox/` directory:

- Container settings
- Protected directory list
- Custom environment variables

### Environment Detection

- Marker file `/.agent-sandbox` indicates sandbox environment
- Used by other tools (like agent-precommit) for conditional behavior

## Security Features

### Process Isolation

- Runs as non-root user (`node`)
- Limited container capabilities
- No privileged operations

### Filesystem Protection

- Readonly bind mounts for sensitive directories
- Workspace mounted with write access (except protected paths)

### Network Isolation

- Default-deny outbound policy
- Explicit allowlist for required services
- No inbound by default (unless ports are published)

## Testing

### Test Scripts

- `test-git-wrapper.sh` - Validates git wrapper functionality
  - Tests blocked commands
  - Verifies allowed operations
  - Checks bypass prevention

### Integration Testing

- Manual testing in sandbox environment
- Verification of firewall rules
- CLI functionality validation
